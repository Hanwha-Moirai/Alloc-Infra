version: "3.9"

services:
  mariadb:
    image: mariadb:11.4
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MARIADB_DATABASE: ${MARIADB_DATABASE:-alloc}
      MARIADB_USER: ${MARIADB_USER:-alloc}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
    ports:
      - "3307:3306"
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./docs/auth-db/docker-init.sql:/docker-entrypoint-initdb.d/01-auth.sql:ro
    networks:
      - moirai

  auth-service:
    build:
      context: .
      dockerfile: auth-service/Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:mariadb://mariadb:3306/auth
      SPRING_DATASOURCE_USERNAME: ${AUTH_DB_USER:-auth}
      SPRING_DATASOURCE_PASSWORD: ${AUTH_DB_PASSWORD}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: always
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_COMPONENTS: always
      MANAGEMENT_ENDPOINT_HEALTH_PROBES_ENABLED: "true"
      SPRING_DATA_REDIS_HOST: ${REDIS_HOST:-alloc-redis}
      SPRING_DATA_REDIS_PORT: ${REDIS_PORT:-6379}
      SPRING_MAIL_USERNAME: ${MAIL_USERNAME}
      SPRING_MAIL_PASSWORD: ${MAIL_PASSWORD}
      ALLOC_INTERNAL_BASE_URL: http://alloc-service:8080
      JWT_SECRET: ${JWT_SECRET}
      JWT_ACCESS_EXP: ${JWT_ACCESS_EXP:-1800}
      JWT_REFRESH_EXP: ${JWT_REFRESH_EXP:-1209600}
    depends_on:
      - mariadb
    ports:
      - "8084:8081"
    networks:
      - moirai

  alloc-service:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:mariadb://mariadb:3306/alloc
      SPRING_DATASOURCE_USERNAME: ${ALLOC_DB_USER:-alloc}
      SPRING_DATASOURCE_PASSWORD: ${ALLOC_DB_PASSWORD}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: always
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_COMPONENTS: always
      MANAGEMENT_ENDPOINT_HEALTH_PROBES_ENABLED: "true"
      SPRING_DATA_REDIS_HOST: ${REDIS_HOST:-alloc-redis}
      SPRING_DATA_REDIS_PORT: ${REDIS_PORT:-6379}
      SPRING_MAIL_USERNAME: ${MAIL_USERNAME}
      SPRING_MAIL_PASSWORD: ${MAIL_PASSWORD}
      AUTH_SYNC_BASE_URL: http://auth-service:8082
      OPENSEARCH_HOST: ${OPENSEARCH_HOST:-opensearch}
      OPENSEARCH_PORT: ${OPENSEARCH_PORT:-9200}
      OPENSEARCH_SCHEME: ${OPENSEARCH_SCHEME:-http}
      OPENSEARCH_USERNAME: ${OPENSEARCH_USERNAME}
      OPENSEARCH_PASSWORD: ${OPENSEARCH_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      JWT_ACCESS_EXP: ${JWT_ACCESS_EXP:-1800}
      JWT_REFRESH_EXP: ${JWT_REFRESH_EXP:-1209600}
    depends_on:
      - mariadb
    ports:
      - "8083:8080"
    networks:
      - moirai

  gateway:
    build:
      context: .
      dockerfile: gateway/Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: docker
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      - alloc-service
      - auth-service
    ports:
      - "8085:8081"
    networks:
      - moirai

networks:
  moirai:

volumes:
  mariadb_data:
