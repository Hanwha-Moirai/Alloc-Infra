services:
  mariadb:
    image: mariadb:11.4
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MARIADB_DATABASE: ${MARIADB_DATABASE:-alloc}
      MARIADB_USER: ${MARIADB_USER:-alloc}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
    ports:
      - "3307:3306"
    volumes:
      - mariadb_data:/var/lib/mysql
    networks:
      - moirai
    healthcheck:
      test: ["CMD-SHELL", "mariadb-admin ping -h 127.0.0.1 -p$${MARIADB_ROOT_PASSWORD} --silent"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - moirai
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20
    restart: unless-stopped

  opensearch:
    image: opensearchproject/opensearch:2.12.0
    environment:
      discovery.type: single-node
      OPENSEARCH_JAVA_OPTS: "-Xms512m -Xmx512m"
      OPENSEARCH_INITIAL_ADMIN_PASSWORD: ${OPENSEARCH_INITIAL_ADMIN_PASSWORD}
      # 로컬 통합 테스트
      plugins.security.disabled: "true"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    ports:
      - "9200:9200"
      - "9600:9600"
    volumes:
      - opensearch_data:/usr/share/opensearch/data
    networks:
      - moirai
    # 컨테이너 내부에서 9200 포트가 열렸는지만 체크
    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'exec 3<>/dev/tcp/127.0.0.1/9200'"]
      interval: 10s
      timeout: 5s
      retries: 30
    restart: unless-stopped

  moirai-auth:
    image: moirai-auth:latest
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: ${AUTH_DB_URL}
      SPRING_DATASOURCE_USERNAME: ${AUTH_DB_USER:-auth}
      SPRING_DATASOURCE_PASSWORD: ${AUTH_DB_PASSWORD}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: always
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_COMPONENTS: always
      MANAGEMENT_ENDPOINT_HEALTH_PROBES_ENABLED: "true"

      # 내부 DNS로 Redis 연결
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379

      SPRING_MAIL_USERNAME: ${MAIL_USERNAME}
      SPRING_MAIL_PASSWORD: ${MAIL_PASSWORD}
      ALLOC_INTERNAL_BASE_URL: http://moirai-alloc:8080
      JWT_SECRET: ${JWT_SECRET}
      JWT_ACCESS_EXP: ${JWT_ACCESS_EXP:-1800}
      JWT_REFRESH_EXP: ${JWT_REFRESH_EXP:-1209600}
    depends_on:
      mariadb:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "18082:8082"
    networks:
      - moirai
    restart: unless-stopped

  moirai-alloc:
    image: moirai-alloc:latest
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: ${ALLOC_DB_URL}
      SPRING_DATASOURCE_USERNAME: ${ALLOC_DB_USER:-alloc}
      SPRING_DATASOURCE_PASSWORD: ${ALLOC_DB_PASSWORD}
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: always
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_COMPONENTS: always
      MANAGEMENT_ENDPOINT_HEALTH_PROBES_ENABLED: "true"

      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379

      SPRING_MAIL_USERNAME: ${MAIL_USERNAME}
      SPRING_MAIL_PASSWORD: ${MAIL_PASSWORD}
      AUTH_SYNC_BASE_URL: http://moirai-auth:8082

      # 내부 DNS로 OpenSearch 연결
      OPENSEARCH_HOST: opensearch
      OPENSEARCH_PORT: 9200
      OPENSEARCH_SCHEME: http

      OPENSEARCH_USERNAME: ${OPENSEARCH_USERNAME:-}
      OPENSEARCH_PASSWORD: ${OPENSEARCH_PASSWORD:-}

      JWT_SECRET: ${JWT_SECRET}
      JWT_ACCESS_EXP: ${JWT_ACCESS_EXP:-1800}
      JWT_REFRESH_EXP: ${JWT_REFRESH_EXP:-1209600}
    depends_on:
      mariadb:
        condition: service_healthy
      redis:
        condition: service_healthy
      opensearch:
        condition: service_healthy
      moirai-auth:
        condition: service_started
    ports:
      - "18080:8080"
    networks:
      - moirai
    restart: unless-stopped

  moirai-gateway:
    image: moirai-gateway:latest
    environment:
      SPRING_PROFILES_ACTIVE: docker
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      moirai-alloc:
        condition: service_started
      moirai-auth:
        condition: service_started
    ports:
      - "18081:8081"
    networks:
      - moirai
    restart: unless-stopped

networks:
  moirai:

volumes:
  mariadb_data:
  redis_data:
  opensearch_data: